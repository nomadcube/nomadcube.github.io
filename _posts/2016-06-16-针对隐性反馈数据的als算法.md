---
layout: post
tags: 推荐算法
---

推荐算法的核心在于预测用户对物品的偏好，协同过滤是一簇只基于用户评分数据就可以完成这个预测的模型。

#### **协同过滤简介**

协同过滤分成两种：

1. memory-based
2. model-based

前者包括itemCF和userCF, 是指使用基于某个特定用户的历史行为数据来预测他对其它物品的偏好分数，并且在这个过程中使用了"k近邻"的思想。比如itemCF预测用户$$u$$对物品$$i$$的分数时使用的公式是$$p(u, i) = \frac{\sum_{j \in S^k(i)} S_{ij}r_{uj}}{\sum_{j \in S^k(i)} S_{ij}}$$, 其中$$S^k(i)$$是指物品$$i$$的$$k$$个最近邻居。

后者比如SVD/LSI/LDA/ALS等, 统称为MF即Matrix Factorization，将评分矩阵分解成2个低秩矩阵，分别代表用户隐变量矩阵$$X$$和物品隐变量矩阵$$Y$$。在预测用户$$u$$对物品$$i$$的分数时，只需要将对应的向量$$X_u$$和$$Y_i$$做点积，而不需要$$u$$的历史行为数据。

在推荐算法，矩阵分解模型的假设是$$A=UV$$, 即评分矩阵可以分解为用户因子矩阵和物品因子矩阵的乘积。

假设$$U,V$$分别是$$m*k, n*k$$维矩阵，那么这个矩阵分解模型的参数个数是$$(m+n)*k$$.

当A为评分矩阵时，模型求解目标一般是使得由U,V重新估计出来的评分矩阵和真实评分矩阵A最大程度地接近，也就是使用平方损失函数。这时候最简单的模型求解方式是用SGD.

但当取的是显式评分时，评分矩阵会有缺失值，因为不可能每个用户都对所有的物品有评分。这时候就引出了SVD的变式：只使用有评分的矩阵元素来训练模型。也就是所谓的SVD++算法。

而ALS模型作为SVD模型的另一种变式，它主要解决的是隐式反馈的问题。这时候评分矩阵的元素代表的是用户的物品的操作次数，当操作次数为0时不能简单地认为用户对这个物品偏好度为0，只能认为相比起那些操作次数较多或较深的物品，用户对这个物品偏好的可能性比较低。因此ALS对隐式评分的处理方式是用信心因子进行加权，然后矩阵分解算法在所有元素上进行训练。

SVD++算法相当于特征空间只由用户、物品ID组成的FM模型，而且使用的是平方损失函数。


#### **普通矩阵分解算法在隐性反馈数据上的问题**
在完整矩阵上的矩阵分解求解，最优化目标函数一般使用平方损失函数，加上L2正则项。即经验损失函数为$$J(X,Y) = \sum_{u,i} ((r_{ui} - x_u^Ty_i)^2 + \lambda(x_ux_u^T + y_iy_i^T))$$. 而在推荐算法中遇到的矩阵分解问题是包含缺失值的，算法的目标恰恰是要将缺失值预测出来。应对这个问题的方法有以下几种：

1. 忽略缺失值，最优化目标只由非缺失值决定
2. 人工填补缺失值之后再按完整矩阵的方法进行分解
3. 将缺失值考虑到损失函数中，但所占的权重和非缺失值不一样

方法1对于显性反馈数据来说是合理的，因为一般在显性反馈数据中，用户对物品的偏好是正面还是负面，已经反映在评分中。但对于隐性反馈数据来说，所能收集到的是行为，无法明确地转换成正面反馈还是负面反馈，"有1个行为"、"没有行为"、"有多个行为"这几个事件并没有明确地反映用户的偏好，而"没有行为"正好是隐性评分数据集中的缺失值，因此不能简单地忽略。ALS正是用第3种方法来解决隐式反馈数据中的矩阵分解问题。

#### **针对隐性反馈数据的ALS变式**
基本的ALS也是适用于显性反馈数据的，只不过是用交替最小二乘法（Alternating Least Square）而不是随机梯度下降来进行求解，这也是为什么它叫ALS的原因。

但针对隐性反馈数据的以上三个特点，ALS做了两个修正：

1. 将原评分矩阵中的零元素也考虑进去经验损失函数中
2. 各个元素对经验损失函数的贡献权重不一致，具体用confidence值来衡量

经过以上修正后，ALS的经验损失函数为：$$J(X,Y) = \sum_{u,i} (c_{ui}(p_{ui} - x_u^Ty_i)^2 + \lambda(x_ux_u^T + y_iy_i^T))$$，其中$$c_{ui} = 1 + \alpha r_{ui}$$就是confidence值。因此可以看到在原评分矩阵中元素值$$r_{ui}$$越大，confidence值就越大，也就是说，认为这个评分值更可信。同时，对于原评分矩阵中的零元素，confidence值为1，和非零元素之间的缩放比例取决于$$\alpha$$的大小。

因此，理论上来说，在隐性反馈数据上，这样的ALS变式表现会更好，但和所有的模型一样，它都有一些假设上或使用场景上的限制，比如更适用于"操作次数越多代表正反馈越强"的场景，比如电商上的购买、在线音乐的播放。但有时候操作次数越多并不一定代表更强的正反馈，比如应用商店的安装，特定用户对同一个应用多次下载背后隐含着一个事实是，这个用户对这个应用曾经有多次卸载行为。
